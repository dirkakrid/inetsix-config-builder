system {
    host-name leaf01;
    services {
        ssh;
        netconf {
            ssh;
        }
    }
    ntp {
        peer None;
    }
}
chassis {
    aggregated-devices {
        ethernet {
            device-count 4;
        }
    }
}
interfaces {
    xe-0/0/6 {
        description "access to FR-EX3300-1-133";
        ether-options {
            auto-negotiation;
        }
        unit 0 {
            family ethernet-switching {
                interface-mode trunk;
                vlan {
                    members bd101;
                }
            }
        }
    }
    xe-0/0/7 {
        description "access to FR-EX3300-1-133";
        esi {
            00:01:00:00:00:00:00:00:00:07;
            all-active;
        }
        ether-options {
            auto-negotiation;
        }
        unit 0 {
            family ethernet-switching {
                interface-mode trunk;
                vlan {
                    members bd102;
                }
            }
        }
    }
    xe-0/0/42 {
        description "Slawomir - vmware host vmnic7";
        ether-options {
            auto-negotiation;
        }
        unit 0 {
            family ethernet-switching {
                interface-mode trunk;
                vlan {
                    members bd101;
                }
            }
        }
    }
    xe-0/0/44 {
        description "Slawomir - vmware host vmnic6";
        ether-options {
            auto-negotiation;
        }
        unit 0 {
            family ethernet-switching {
                interface-mode trunk;
                vlan {
                    members [ bd101 bd102 ];
                }
            }
        }
    }
    xe-0/0/46 {
        description "Slawomir - lab34 - eth2";
        hold-time up 60000 down 1;
        esi {
            00:10:00:00:00:00:00:00:00:06;
            all-active;
        }
        ether-options {
            auto-negotiation;
        }
        unit 0 {
            family ethernet-switching {
                interface-mode trunk;
                vlan {
                    members bd101;
                }
            }
        }
    }
    /* CUSTOMER Interfaces */
    xe-0/0/46 {
        description vmware host vmnic6;
        
        unit 0 {
            family ethernet-switching {
                interface-mode access;
                vlan {
                    members [ bd101 ]
                }
            }
        }
    }
    xe-0/0/45 {
        description vmware host vmnic5;
        
        unit 0 {
            family ethernet-switching {
                interface-mode trunk;
                vlan {
                    members [ bd101 bd102 bd103 bd104 ]
                }
            }
        }
    }
    xe-0/0/43 {
        description vmware host vmnic5;
        esi {
            00:01:00:00:00:00:00:00:00:07;
            all-active;
        }
        unit 0 {
            family ethernet-switching {
                interface-mode trunk;
                vlan {
                    members [ bd101 bd102 bd103 bd104 ]
                }
            }
        }
    }
    /* UPLINK to all Fabric Switches */
    et-0/0/48 {
        description "UPLINK - L1 to S1 - 192.168.0.0/31";
        mtu 9000;
        unit 0 {
            family inet {
                address 192.168.0.0/31;
            }
        }
    }
    et-0/0/47 {
        description "UPLINK - L1 to S2 - 192.168.0.2/31";
        mtu 9000;
        unit 0 {
            family inet {
                address 192.168.0.2/31;
            }
        }
    }
    lo0 {
        description "Loopback Interface";
        unit 0 {
            family inet {
                primary;
                address 10.30.0.1;
            }
        }
    }
    vme {
        description "management interface";
        unit 0 {
            family inet {
                address None;
            }
        }
    }
}
routing-options {
    graceful-restart;
    static {
        route 0.0.0.0/0 next-hop None;
    }
    router-id 10.30.0.1;
    forwarding-table {
        export bgp-ecmp;
    }
}
protocols {
    bgp {
        log-updown;
        group UNDERLAY-EBGP-FAB {
            type external;
            import bgp-underlay-in;
            family inet {
                unicast;
            }
            export bgp-underlay-out;
            local-as None;
            graceful-restart;
            bfd-liveness-detection {
                minimum-interval 350;
                multiplier 3;
                session-mode single-hop;
            }
            multipath multiple-as;
            neighbor 192.168.0.2 { 
                peer-as 102;
                description "SPINE02";
            }
            neighbor 192.168.0.1 { 
                peer-as 101;
                description "SPINE01";
            }
        }
        group OVERLAY-iBGP {
            type internal;
            local-address 10.30.0.1;
            family inet-vpn {
                unicast;
            }
            family evpn {
                signaling;
            }
            cluster 10.30.0.1;
            local-as None;
            bfd-liveness-detection {
                minimum-interval 350;
                multiplier 3;
                session-mode automatic;
            }
            multipath;
            neighbor 10.30.1.2 { 
                description "FABRIC02";
            }
            neighbor 10.30.1.1 { 
                description "FABRIC01";
            }
        }
    }
    evpn {
        vni-options {
            vni 104 { 
                vrf-target export target:3:104;
            }
            vni 101 { 
                vrf-target export target:3:101;
            }
            vni 102 { 
                vrf-target export target:3:102;
            }
            vni 103 { 
                vrf-target export target:3:103;
            }
        }
        encapsulation vxlan;
        extended-vni-list [ 104 101 102 103];
        multicast-mode ingress-replication;
    }
    lldp {
        interface all;
    }
}
policy-options {
    policy-statement LEAF-IN {
        term ESI_LEAF {
            from community commEsi;
            then accept;
        }term  commTenant2 { 
            from commTenant2;
            then accept;
        }
        term  commTenant1 { 
            from commTenant1;
            then accept;
        }
        term  commTenant1_vni4 { 
            from commTenant1_vni4;
            then accept;
        }
        term  commTenant1_vni1 { 
            from commTenant1_vni1;
            then accept;
        }
        term  commTenant1_vni2 { 
            from commTenant1_vni2;
            then accept;
        }
        term  commTenant1_vni3 { 
            from commTenant1_vni3;
            then accept;
        }
        
        then reject;
    }
    policy-statement bgp-ecmp {
        then {
            load-balance per-packet;
        }
    }
    policy-statement bgp-underlay-in {
        then accept;
    }
    policy-statement bgp-underlay-out {
        term LOOPBACK {
            from {
                route-filter None longer;
            }
            then accept;
        }
        term IP_FABRIC_SUPERNET {
            from {
                route-filter None longer;
            }
            then accept;
        }
        then reject;
    }
    community commEsi members target:1:99;
    community commTenant2 members target:2:102;
    community commTenant1 members target:2:101;
    community commTenant1_vni4 members target:3:104;
    community commTenant1_vni1 members target:3:101;
    community commTenant1_vni2 members target:3:102;
    community commTenant1_vni3 members target:3:103;
    
}
switch-options {
    vtep-source-interface lo0.0;
    route-distinguisher 10.30.0.1:1;
    vrf-import LEAF-IN;
    vrf-target target:1:99;
}
vlans {
    bd104 {
        description "tenant 1 - Bridge Domain for vlan 104";
        vlan-id 104;
        vxlan {
            vni 104;
            ingress-node-replication;
        }
    }
    bd101 {
        description "tenant 1 - Bridge Domain for vlan 101";
        vlan-id 101;
        vxlan {
            vni 101;
            ingress-node-replication;
        }
    }
    bd102 {
        description "tenant 1 - Bridge Domain for vlan 102";
        vlan-id 102;
        vxlan {
            vni 102;
            ingress-node-replication;
        }
    }
    bd103 {
        description "tenant 1 - Bridge Domain for vlan 103";
        vlan-id 103;
        vxlan {
            vni 103;
            ingress-node-replication;
        }
    }
}